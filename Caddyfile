# Caddy Configuration for Wan 2.2 Video Generator
# Add this to your existing Caddyfile or use it standalone

# Global configuration
{
  email admin@labfab.ca
  # Use Let's Encrypt production
  # acme_ca https://acme-v02.api.letsencrypt.org/directory
}

# Health check endpoint for Docker healthcheck
:80 {
  handle /health {
    respond "OK" 200
  }
}

# Video Generator Domain
video.labfab.ca {
  # Enable compression
  encode gzip zstd

  # Reverse proxy to Next.js container
  # Docker service name resolves via internal DNS
  reverse_proxy wan-video-generator:3000 {
    # Forward client information
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
    header_up X-Forwarded-Proto {scheme}
    header_up Host {host}

    # Health check configuration
    health_uri /api/health
    health_interval 30s
    health_timeout 10s

    # WebSocket support (for potential real-time features)
    header_up Connection {>Connection}
    header_up Upgrade {>Upgrade}
  }

  # Security headers
  header {
    # HSTS - Force HTTPS
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Prevent MIME type sniffing
    X-Content-Type-Options "nosniff"

    # Prevent clickjacking
    X-Frame-Options "SAMEORIGIN"

    # XSS Protection
    X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Referrer-Policy "strict-origin-when-cross-origin"

    # Content Security Policy
    # Adjust if you need external resources
    Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.runpod.ai;"

    # Remove server identification
    -Server
  }

  # Access logging
  log {
    output file /data/access-video.log {
      roll_size 10mb
      roll_keep 5
      roll_keep_for 720h
    }
    format json
    level INFO
  }

  # Handle errors gracefully
  handle_errors {
    respond "{http.error.status_code} {http.error.status_text}"
  }
}

# Optional: Redirect www subdomain
www.video.labfab.ca {
  redir https://video.labfab.ca{uri} permanent
}
